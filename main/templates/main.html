{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Football Product - Goal Store</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="bg-gray-50 w-full pt-16 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Latest Football Products</h1>
      <p class="text-gray-600">Find and share your favorite football gear</p>
    </div>

    <!-- Button Section -->
    <div class="flex justify-between mb-6">
      <button onclick="showModal()" class="inline-flex items-center px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition">
        + Create Product
      </button>

      <button id="refreshBtn" class="inline-flex items-center px-4 py-2 bg-white text-green-600 font-semibold border border-green-600 rounded-md hover:bg-green-600 hover:text-white transition">
        Refresh
      </button>
    </div>

        <!-- Filter Buttons -->
    <div class="flex flex-wrap gap-3 mb-6">
      <button id="filterAll" class="px-4 py-2 bg-green-600 text-white rounded-md font-medium hover:bg-green-700 transition">
        All Products
      </button>
      <button id="filterMine" class="px-4 py-2 bg-white text-green-600 border border-green-600 rounded-md font-medium hover:bg-green-600 hover:text-white transition">
        My Products
      </button>
    </div>

    <!-- Empty State -->
    <div id="empty" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
      <div class="w-32 h-32 mx-auto mb-4">
        <img src="{% static 'image/no-product.png' %}" alt="No product available" class="w-full h-full object-contain">
      </div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No Product</h3>
      <p class="text-gray-500 mb-6">You haven‚Äôt created any products yet.</p>
      <button onclick="showModal()" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">
        Create Product
      </button>
    </div>


    <!-- Loading / Empty / Error / Grid -->
    <div id="loading" class="text-center py-10 hidden">Loading...</div>
    <div id="error" class="text-center text-red-600 py-10 hidden">Failed to load products.</div>
    <div id="empty" class="text-center text-gray-500 py-10 hidden">No products yet.</div>
    <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 hidden"></div>
  </div>
</div>

<!-- Include modal & toast -->
{% include 'modal.html' %}
{% include 'toast.html' %}

<script>
const PRODUCT_API_ENDPOINT = "{% url 'main:show_json' %}";
const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

const loading = document.getElementById('loading');
const errorMsg = document.getElementById('error');
const empty = document.getElementById('empty');
const grid = document.getElementById('grid');

let allProducts = [];
let activeFilter = 'all';

// =================== DISPLAY STATE ===================
function display({ showLoading=false, showError=false, showEmpty=false, showGrid=false }) {
  loading.classList.toggle('hidden', !showLoading);
  errorMsg.classList.toggle('hidden', !showError);
  empty.classList.toggle('hidden', !showEmpty);
  grid.classList.toggle('hidden', !showGrid);
}

// =================== ANIMATION HELPERS ===================
async function fadeOut(element) {
  element.classList.add('opacity-0');
  element.classList.remove('opacity-100');
  await new Promise(r => setTimeout(r, 200)); // 0.2s
}

async function fadeIn(element) {
  element.classList.remove('opacity-0');
  element.classList.add('opacity-100');
}

// =================== BUILD PRODUCT CARD ===================
function buildProductCard(item) {
  const card = document.createElement('article');
  card.className = 'bg-white rounded-lg border border-gray-200 hover:shadow-lg transition overflow-hidden flex flex-col opacity-0 transition-opacity duration-300';
  card.id = `product-${item.id}`;

  const detailUrl = `/product/${item.id}/`;
  const thumbnail = item.thumbnail
    ? `<img src="${item.thumbnail}" alt="${item.name}" class="w-full h-48 object-cover">`
    : `<div class='w-full h-48 bg-gray-200 flex items-center justify-center text-gray-400'>No Image</div>`;

  const isOwner = String(item.user_id) === String(CURRENT_USER_ID);
  const actionButtons = isOwner
    ? `
      <button class="text-sm px-3 py-1.5 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition" onclick="openEditModal('${item.id}','${item.name}','${item.price}','${item.stock}','${item.description}','${item.thumbnail}','${item.category}','${item.condition}','${item.is_featured}')">‚úèÔ∏è Edit</button>
      <button class="text-sm px-3 py-1.5 bg-red-600 text-white rounded-md hover:bg-red-700 transition" onclick="deleteProduct('${item.id}')">üóëÔ∏è Delete</button>
    `
    : `
      <button class="text-sm px-3 py-1.5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition" onclick="buyProduct('${item.id}')">üõí Buy</button>
    `;

  card.innerHTML = `
    <div class="relative">
      <a href="${detailUrl}">
        ${thumbnail}
      </a>
      <div class="absolute bottom-2 left-2 flex flex-wrap gap-2">
        <span class="px-2 py-0.5 rounded-md text-xs font-medium bg-green-600 text-white shadow">${item.category}</span>
        ${item.is_featured ? `<span class="px-2 py-0.5 rounded-md text-xs font-medium bg-yellow-400 text-yellow-900 shadow">Featured</span>` : ''}
      </div>
    </div>
    <div class="flex-1 flex flex-col p-5">
      <div class="mb-3">
        <h3 class="text-lg font-semibold text-gray-900 mb-1">
          <a href="${detailUrl}" class="hover:text-green-600 transition">${item.name}</a>
        </h3>
        <p class="text-green-700 font-bold text-sm">Rp ${item.price}</p>
        <p class="text-gray-500 text-xs">Stock: ${item.stock}</p>
      </div>
      <p class="text-gray-600 text-sm leading-relaxed flex-1 mb-4 line-clamp-3">${item.description}</p>
      <div class="flex items-center justify-between pt-4 border-t border-gray-100">
        ${actionButtons}
      </div>
    </div>`;
  return card;
}

// =================== RENDER PRODUCTS ===================
async function renderFilteredProducts() {
  await fadeOut(grid); // fade out old cards
  grid.innerHTML = '';

  let filtered = allProducts;
  if (activeFilter === 'mine') {
    filtered = allProducts.filter(p => String(p.user_id) === String(CURRENT_USER_ID));
  }

  if (filtered.length === 0) {
    display({ showEmpty: true });
    return;
  }

  filtered.forEach(p => grid.appendChild(buildProductCard(p)));
  display({ showGrid: true });

  // Fade in each card sequentially for effect
  const cards = grid.querySelectorAll('article');
  cards.forEach((c, i) => {
    setTimeout(() => {
      c.classList.remove('opacity-0');
      c.classList.add('opacity-100');
    }, 100 * i);
  });

  await fadeIn(grid);
}

// =================== FETCH PRODUCTS ===================
async function refreshProducts() {
  try {
    display({ showLoading: true });
    const res = await fetch(PRODUCT_API_ENDPOINT, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error('Failed to fetch');
    const data = await res.json();
    allProducts = data;
    renderFilteredProducts();
  } catch (e) {
    console.error(e);
    display({ showError: true });
  }
}

// =================== DELETE PRODUCT ===================
async function deleteProduct(id) {
  if (!confirm("Are you sure you want to delete this product?")) return;
  const res = await fetch(`/ajax/product/${id}/delete/`, { method: "POST" });
  const data = await res.json();

  if (res.ok) {
    showToast("Deleted", "Product deleted successfully", "success");
    const card = document.getElementById(`product-${id}`);
    if (card) {
      card.classList.add('opacity-0');
      setTimeout(() => card.remove(), 300);
    }
    allProducts = allProducts.filter(p => p.id !== id);
    setTimeout(renderFilteredProducts, 300);
  } else {
    showToast("Error", data.error || "Failed to delete product", "error");
  }
}

// =================== BUY PRODUCT ===================
async function buyProduct(id) {
  const res = await fetch(`/ajax/product/${id}/buy/`, { method: "POST" });
  const data = await res.json();

  if (res.ok) {
    showToast("Purchased", data.message, "success");
    const product = allProducts.find(p => p.id === id);
    if (product) product.stock = Math.max(product.stock - 1, 0);
    renderFilteredProducts();
  } else {
    showToast("Error", data.error || "Failed to buy product", "error");
  }
}

// =================== FILTER BUTTONS ===================
document.getElementById('filterAll').addEventListener('click', async () => {
  activeFilter = 'all';
  updateFilterButtonUI();
  await renderFilteredProducts();
});

document.getElementById('filterMine').addEventListener('click', async () => {
  activeFilter = 'mine';
  updateFilterButtonUI();
  await renderFilteredProducts();
});

function updateFilterButtonUI() {
  const allBtn = document.getElementById('filterAll');
  const mineBtn = document.getElementById('filterMine');
  if (activeFilter === 'all') {
    allBtn.className = 'px-4 py-2 bg-green-600 text-white rounded-md font-medium hover:bg-green-700 transition';
    mineBtn.className = 'px-4 py-2 bg-white text-green-600 border border-green-600 rounded-md font-medium hover:bg-green-600 hover:text-white transition';
  } else {
    mineBtn.className = 'px-4 py-2 bg-green-600 text-white rounded-md font-medium hover:bg-green-700 transition';
    allBtn.className = 'px-4 py-2 bg-white text-green-600 border border-green-600 rounded-md font-medium hover:bg-green-600 hover:text-white transition';
  }
}

// =================== REFRESH BUTTON ===================
document.getElementById('refreshBtn').addEventListener('click', async () => {
  showToast("Refreshing", "Fetching latest products...", "normal");
  await fadeOut(grid);
  refreshProducts();
});

// =================== INIT ===================
document.addEventListener("productChanged", refreshProducts);
refreshProducts();
</script>


{% endblock content %}
